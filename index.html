<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novela Manager - Fixes</title>
    <style>
        :root { --bg-dark: #1a1a1b; --card-bg: #272729; --accent: #0079d3; --border: #343435; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background-color: var(--bg-dark); color: #d7dadc; height: 100vh; overflow: hidden; }
        
        /* MENÚ LATERAL */
        nav { width: 220px; background: #000; padding: 20px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid var(--border); }
        nav h2 { font-size: 1.2rem; color: var(--accent); margin-bottom: 20px; text-align: center; }
        nav button { background: transparent; color: #ccc; border: none; padding: 12px; text-align: left; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        nav button:hover, nav button.active { background: var(--card-bg); color: white; }

        /* CONTENIDO PRINCIPAL */
        main { flex: 1; padding: 40px; overflow-y: auto; }
        .vista { display: none; }
        .vista.active { display: block; }

        .seccion { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        input, textarea, select { padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 6px; width: 100%; box-sizing: border-box; background: var(--bg-dark); color: white; font-size: 1rem; }
        
        /* Estilo para el input de color */
        input[type="color"] { height: 50px; cursor: pointer; padding: 2px; }

        button.primary { background-color: var(--accent); color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        button.btn-editar { background: #4a4a4b; width: auto; padding: 6px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* LISTAS Y BADGES */
        .personaje-item { background: var(--card-bg); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        /* Contenedor de círculos con separación del nombre */
        .grid-badges { display: flex; gap: 6px; width: 110px; flex-shrink: 0; margin-right: 15px; }
        .badge-fixed { width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        
        .poder-tag { padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: #000; min-width: 100px; text-align: center; }
        
        /* Selectores de personajes y clasificaciones */
        .selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; background: var(--bg-dark); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid #000; }
    </style>
</head>
<body>

    <nav>
        <h2>Novela Manager</h2>
        <button onclick="cambiarVista('v-eventos')" id="btn-v-eventos" class="active">Línea de Tiempo</button>
        <button onclick="cambiarVista('v-personajes')" id="btn-v-personajes">Personajes</button>
        <button onclick="cambiarVista('v-clas')" id="btn-v-clas">Clasificaciones</button>
    </nav>

    <main>
        <div id="v-eventos" class="vista active">
            <div class="seccion">
                <h3>Registrar Evento Histórico</h3>
                <input type="text" id="nombreE" placeholder="Título del evento">
                <input type="date" id="fechaE">
                <textarea id="descE" placeholder="Descripción..."></textarea>
                <p>Personajes en el evento:</p>
                <div id="selectorP-Evento" class="selector-grid"></div>
                <button class="primary" onclick="agregarEvento()">Guardar Evento</button>
            </div>
            <h3>Crónica del Mundo</h3>
            <div id="listaEventos"></div>
        </div>

        <div id="v-personajes" class="vista">
            <div class="seccion">
                <h3 id="tituloFormP">Registro de Personaje</h3>
                <input type="hidden" id="editIndex" value="-1">
                <input type="text" id="nombreP" placeholder="Nombre completo">
                <input type="date" id="fechaP">
                <p>Clasificaciones:</p>
                <div id="checksClasificaciones" class="selector-grid"></div>
                <p>Estado de Poder:</p>
                <div class="selector-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <label class="check-item"><input type="radio" name="poderP" value="tiene"> Con Poder</label>
                    <label class="check-item"><input type="radio" name="poderP" value="no"> Sin Poder</label>
                    <label class="check-item"><input type="radio" name="poderP" value="indefinido" checked> Indefinido</label>
                </div>
                <button class="primary" onclick="guardarPersonaje()">Guardar Personaje</button>
            </div>
            <h3>Lista de Personajes</h3>
            <div id="listaPersonajes"></div>
        </div>

        <div id="v-clas" class="vista">
            <div class="seccion">
                <h3>Gestionar Clasificaciones</h3>
                <input type="text" id="nombreClas" placeholder="Nombre (ej: Realeza)">
                <label>Color de la clasificación:</label>
                <input type="color" id="colorClas" value="#0079d3">
                <button class="primary" onclick="agregarClasificacion()">Crear Clasificación</button>
            </div>
            <h3>Clasificaciones actuales</h3>
            <div id="verClasificaciones" class="seccion"></div>
        </div>
    </main>

    <script>
        function cambiarVista(idVista) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(idVista).classList.add('active');
            document.getElementById('btn-' + idVista).classList.add('active');
            if(idVista === 'v-eventos') actualizarSelectorPersonajes();
            if(idVista === 'v-personajes') mostrarClasificaciones(); 
        }

        window.onload = function() {
            mostrarClasificaciones();
            mostrarPersonajes();
            mostrarEventos();
            actualizarSelectorPersonajes();
        };

        // --- CLASIFICACIONES ---
        function agregarClasificacion() {
            const nombre = document.getElementById('nombreClas').value;
            const color = document.getElementById('colorClas').value;
            if(!nombre) return;
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            clas.push({ id: Date.now().toString(), nombre, color });
            localStorage.setItem('nt_clas', JSON.stringify(clas));
            document.getElementById('nombreClas').value = "";
            mostrarClasificaciones();
        }

        function mostrarClasificaciones() {
            const divVer = document.getElementById('verClasificaciones');
            const divChecks = document.getElementById('checksClasificaciones');
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            divVer.innerHTML = ""; divChecks.innerHTML = "";
            clas.forEach(c => {
                const cid = c.id.toString();
                divVer.innerHTML += `<div style="margin-bottom:10px"><span class="color-dot" style="background:${c.color}"></span> ${c.nombre}</div>`;
                divChecks.innerHTML += `<label class="check-item"><input type="checkbox" name="clasP" value="${cid}"> <span class="color-dot" style="background:${c.color}"></span> ${c.nombre}</label>`;
            });
        }

        // --- PERSONAJES ---
        function guardarPersonaje() {
            const nombre = document.getElementById('nombreP').value;
            const fecha = document.getElementById('fechaP').value;
            const editIndex = parseInt(document.getElementById('editIndex').value);
            const poder = document.querySelector('input[name="poderP"]:checked').value;
            const clasIds = Array.from(document.querySelectorAll('input[name="clasP"]:checked')).map(cb => cb.value.toString());

            if(!nombre || !fecha) return alert("Faltan datos");
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            const pData = { nombre, fecha, clasIds, poder };

            if(editIndex === -1) personajes.push(pData);
            else personajes[editIndex] = pData;

            localStorage.setItem('nt_pers', JSON.stringify(personajes));
            document.getElementById('editIndex').value = "-1";
            document.getElementById('nombreP').value = "";
            document.querySelectorAll('input[name="clasP"]').forEach(c => c.checked = false);
            mostrarPersonajes(); actualizarSelectorPersonajes();
        }

        function mostrarPersonajes() {
            const contenedor = document.getElementById('listaPersonajes');
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            contenedor.innerHTML = "";
            personajes.forEach((p, index) => {
                let badgesHtml = '<div class="grid-badges">';
                for(let i=0; i<5; i++) {
                    const pid = p.clasIds[i] ? p.clasIds[i].toString() : null;
                    const c = clas.find(item => item.id.toString() === pid);
                    badgesHtml += `<span class="badge-fixed" style="background:${c ? c.color : 'transparent'}; border:${c?'none':'1px solid #444'}"></span>`;
                }
                badgesHtml += '</div>';
                const tagCol = p.poder==='tiene'?'#2ecc71':(p.poder==='no'?'#e67e22':'#fff');
                const tagTxt = p.poder==='tiene'?'CON PODER':(p.poder==='no'?'SIN PODER':'INDEFINIDO');
                
                contenedor.innerHTML += `<div class="personaje-item">
                    <div style="display:flex; align-items:center">${badgesHtml} <strong>${p.nombre}</strong></div>
                    <div style="display:flex; align-items:center; gap:15px">
                        <span class="poder-tag" style="background:${tagCol}">${tagTxt}</span>
                        <button class="btn-editar" onclick="editarPersonaje(${index})">Editar</button>
                    </div>
                </div>`;
            });
        }

        function editarPersonaje(index) {
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            const p = personajes[index];
            document.getElementById('nombreP').value = p.nombre;
            document.getElementById('fechaP').value = p.fecha;
            document.getElementById('editIndex').value = index;
            mostrarClasificaciones(); // Recargar checks
            setTimeout(() => {
                document.querySelectorAll('input[name="clasP"]').forEach(cb => {
                    cb.checked = p.clasIds.map(id => id.toString()).includes(cb.value.toString());
                });
            }, 50);
            document.querySelector(`input[name="poderP"][value="${p.poder}"]`).checked = true;
            cambiarVista('v-personajes');
        }

        // --- EVENTOS ---
        function actualizarSelectorPersonajes() {
            const selector = document.getElementById('selectorP-Evento');
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            selector.innerHTML = personajes.length ? "" : "Crea personajes primero";
            personajes.forEach((p, idx) => {
                selector.innerHTML += `<label class="check-item"><input type="checkbox" name="pEvento" value="${idx}"> ${p.nombre}</label>`;
            });
        }

        function agregarEvento() {
            const titulo = document.getElementById('nombreE').value;
            const fecha = document.getElementById('fechaE').value;
            const desc = document.getElementById('descE').value;
            const pIndices = Array.from(document.querySelectorAll('input[name="pEvento"]:checked')).map(cb => cb.value);
            if(!titulo || !fecha) return alert("Faltan datos");
            let eventos = JSON.parse(localStorage.getItem('nt_eve')) || [];
            eventos.push({ titulo, fecha, desc, pIndices });
            eventos.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
            localStorage.setItem('nt_eve', JSON.stringify(eventos));
            document.getElementById('nombreE').value = ""; document.getElementById('descE').value = "";
            mostrarEventos();
        }

        function mostrarEventos() {
            const contenedor = document.getElementById('listaEventos');
            let eventos = JSON.parse(localStorage.getItem('nt_eve')) || [];
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            contenedor.innerHTML = "";
            eventos.forEach(ev => {
                let pListHtml = "";
                ev.pIndices.forEach(idx => {
                    const p = personajes[idx];
                    if(p) {
                        const edad = calcularEdadEnFecha(p.fecha, ev.fecha);
                        pListHtml += `<li>${p.nombre} (Edad: ${edad < 0 ? 'No nacido' : edad + ' años'})</li>`;
                    }
                });
                const [y, m, d] = ev.fecha.split('-');
                contenedor.innerHTML += `<div class="seccion" style="background:#1a1a1b; border-left: 4px solid var(--accent)">
                    <h4 style="color:white; margin:0">${d}-${m}-${y} | ${ev.titulo}</h4>
                    <p style="color:#aaa; font-size:0.9rem">${ev.desc}</p>
                    <ul style="font-size:0.85rem; color:#ddd; padding-left:20px">${pListHtml}</ul>
                </div>`;
            });
        }

        function calcularEdadEnFecha(nac, eve) {
            const n = new Date(nac); const e = new Date(eve);
            let edad = e.getFullYear() - n.getFullYear();
            const m = e.getMonth() - n.getMonth();
            if (m < 0 || (m === 0 && e.getDate() < n.getDate())) edad--;
            return edad;
        }
    </script>
</body>
</html>
