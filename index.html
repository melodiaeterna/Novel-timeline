<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novela Timeline - Diseño Limpio</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background-color: #1a1a1b; color: #d7dadc; }
        .seccion { background: #272729; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid #343435; }
        h3 { color: #ffffff; border-bottom: 1px solid #343435; padding-bottom: 10px; margin-top: 0; }
        
        input[type="text"], input[type="date"] { padding: 12px; margin: 10px 0; border: 1px solid #343435; border-radius: 6px; width: 100%; box-sizing: border-box; background: #1a1a1b; color: white; font-size: 1rem; }
        
        button { background-color: #d93a00; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { filter: brightness(1.2); }
        button.btn-azul { background-color: #0079d3; margin-top: 10px; }
        button.btn-editar { background-color: #4a4a4b; width: auto; padding: 6px 12px; font-size: 0.85em; }

        /* Clasificaciones en el Formulario */
        .lista-checks { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; background: #1a1a1b; padding: 15px; border-radius: 8px; border: 1px solid #343435; }
        .clas-check-label { display: flex; align-items: center; cursor: pointer; padding: 8px 14px; border-radius: 20px; border: 2px solid #343435; background: #272729; transition: 0.2s; user-select: none; }
        .clas-check-label:hover { background: #343435; }
        .clas-check-label input { display: none; }
        .clas-check-label input:checked { border-color: white; }
        /* Efecto cuando está seleccionado */
        .clas-check-label:has(input:checked) { border-color: #0079d3; background: #343435; box-shadow: 0 0 5px #0079d3; }
        
        .color-circle { width: 16px; height: 16px; border-radius: 50%; margin-right: 10px; border: 1px solid #000; flex-shrink: 0; }

        /* Lista de Personajes */
        .personaje-item { background: #272729; padding: 15px; border-bottom: 1px solid #343435; display: flex; justify-content: space-between; align-items: center; }
        .info-p { display: flex; align-items: center; }
        
        /* Contenedor invisible para 5 insignias para mantener alineación */
        .grid-badges { display: flex; gap: 8px; width: 120px; flex-shrink: 0; }
        .badge-fixed { width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); flex-shrink: 0; }
        .badge-empty { background: transparent; border: none; }

        /* Etiquetas de Poder más largas */
        .poder-tag { padding: 6px 12px; border-radius: 4px; font-size: 0.75em; font-weight: bold; color: #000; min-width: 100px; text-align: center; display: inline-block; }
    </style>
</head>
<body>

    <h1>Cronología: Panel de Control</h1>

    <div class="seccion">
        <h3>1. Gestionar Clasificaciones</h3>
        <input type="text" id="nombreClas" placeholder="Nombre de la clasificación (ej: Realeza)">
        <div style="display:flex; align-items: center; gap:15px;">
            <label>Color:</label>
            <input type="color" id="colorClas" value="#0079d3" style="width: 100%; height: 45px; background: none; border:none; cursor:pointer;">
        </div>
        <button class="btn-azul" onclick="agregarClasificacion()">Crear Clasificación</button>
        <div id="verClasificaciones" class="lista-checks"></div>
    </div>

    <div class="seccion">
        <h3 id="tituloFormP">2. Registro de Personaje</h3>
        <input type="hidden" id="editIndex" value="-1">
        <input type="text" id="nombreP" placeholder="Nombre completo">
        <input type="date" id="fechaP">
        
        <p><strong>Clasificaciones:</strong></p>
        <div id="checksClasificaciones" class="lista-checks"></div>

        <p><strong>Estado de Poder:</strong></p>
        <div class="lista-checks">
            <label style="cursor:pointer"><input type="radio" name="poderP" value="tiene"> Con Poder</label>
            <label style="cursor:pointer; margin-left:15px;"><input type="radio" name="poderP" value="no"> Sin Poder</label>
            <label style="cursor:pointer; margin-left:15px;"><input type="radio" name="poderP" value="indefinido" checked> Indefinido</label>
        </div>
        
        <button id="btnGuardarP" onclick="guardarPersonaje()">Guardar Personaje</button>
        <button id="btnCancelar" style="display:none; margin-top:8px; background:#444;" onclick="cancelarEdicion()">Descartar Cambios</button>
    </div>

    <div class="seccion">
        <h3>Lista de Personajes</h3>
        <div id="listaPersonajes"></div>
    </div>

    <script>
        window.onload = function() { mostrarClasificaciones(); mostrarPersonajes(); };

        function agregarClasificacion() {
            const nombre = document.getElementById('nombreClas').value;
            const color = document.getElementById('colorClas').value;
            if(!nombre) return;
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            // Guardamos el ID como String para evitar problemas de comparación
            clas.push({ id: Date.now().toString(), nombre, color });
            localStorage.setItem('nt_clas', JSON.stringify(clas));
            document.getElementById('nombreClas').value = "";
            mostrarClasificaciones();
            mostrarPersonajes();
        }

        function mostrarClasificaciones() {
            const divVer = document.getElementById('verClasificaciones');
            const divChecks = document.getElementById('checksClasificaciones');
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            divVer.innerHTML = ""; divChecks.innerHTML = "";
            clas.forEach(c => {
                divVer.innerHTML += `<span><span class="color-circle" style="background:${c.color}; display:inline-block"></span>${c.nombre}</span>`;
                divChecks.innerHTML += `
                    <label class="clas-check-label">
                        <input type="checkbox" name="clasP" value="${c.id}">
                        <span class="color-circle" style="background:${c.color}"></span>
                        ${c.nombre}
                    </label>`;
            });
        }

        function guardarPersonaje() {
            const nombre = document.getElementById('nombreP').value;
            const fecha = document.getElementById('fechaP').value;
            const editIndex = parseInt(document.getElementById('editIndex').value);
            const checks = document.querySelectorAll('input[name="clasP"]:checked');
            const poder = document.querySelector('input[name="poderP"]:checked').value;
            
            if(!nombre || !fecha) return alert("Faltan datos");

            const idsClas = Array.from(checks).map(cb => cb.value);
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];

            const pData = { nombre, fecha, clasIds: idsClas, poder };

            if(editIndex === -1) personajes.push(pData);
            else personajes[editIndex] = pData;

            localStorage.setItem('nt_pers', JSON.stringify(personajes));
            cancelarEdicion();
            mostrarPersonajes();
        }

        function editarPersonaje(index) {
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            const p = personajes[index];
            document.getElementById('nombreP').value = p.nombre;
            document.getElementById('fechaP').value = p.fecha;
            document.getElementById('editIndex').value = index;
            // Aseguramos que la comparación sea correcta convirtiendo a String
            document.querySelectorAll('input[name="clasP"]').forEach(cb => {
                cb.checked = p.clasIds.includes(cb.value);
            });
            document.querySelector(`input[name="poderP"][value="${p.poder || 'indefinido'}"]`).checked = true;
            document.getElementById('tituloFormP').innerText = "Editando: " + p.nombre;
            document.getElementById('btnGuardarP').innerText = "Actualizar";
            document.getElementById('btnCancelar').style.display = "block";
        }

        function cancelarEdicion() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('nombreP').value = "";
            document.getElementById('fechaP').value = "";
            document.getElementById('tituloFormP').innerText = "2. Registro de Personaje";
            document.getElementById('btnGuardarP').innerText = "Guardar Personaje";
            document.getElementById('btnCancelar').style.display = "none";
            document.querySelectorAll('input[name="clasP"]').forEach(cb => cb.checked = false);
            document.querySelector('input[name="poderP"][value="indefinido"]').checked = true;
        }

        function mostrarPersonajes() {
            const contenedor = document.getElementById('listaPersonajes');
            let personajes = JSON.parse(localStorage.getItem('nt_pers')) || [];
            let clas = JSON.parse(localStorage.getItem('nt_clas')) || [];
            contenedor.innerHTML = "";

            personajes.forEach((p, index) => {
                let badgesHtml = '<div class="grid-badges">';
                for(let i=0; i<5; i++) {
                    const idClas = p.clasIds[i];
                    if(idClas) {
                        // Buscamos la clasificación correspondiente para obtener su color
                        const c = clas.find(item => item.id === idClas);
                        const colorFinal = c ? c.color : '#444';
                        badgesHtml += `<span class="badge-fixed" style="background:${colorFinal}" title="${c ? c.nombre : ''}"></span>`;
                    } else {
                        // Espacio vacío pero presente para mantener alineación
                        badgesHtml += `<span class="badge-fixed badge-empty"></span>`;
                    }
                }
                badgesHtml += '</div>';

                const [y, m, d] = p.fecha.split('-');
                const colorP = p.poder === 'tiene' ? '#2ecc71' : (p.poder === 'no' ? '#e67e22' : '#ffffff');
                const labelP = p.poder === 'tiene' ? 'CON PODER' : (p.poder === 'no' ? 'SIN PODER' : 'INDEFINIDO');

                contenedor.innerHTML += `
                    <div class="personaje-item">
                        <div class="info-p">
                            ${badgesHtml}
                            <div style="margin-left:10px">
                                <strong style="font-size: 1.1rem">${p.nombre}</strong><br>
                                <small style="color:#888">Nace: ${d}-${m}-${y}</small>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:20px;">
                            <span class="poder-tag" style="background:${colorP}">${labelP}</span>
                            <button class="btn-editar" onclick="editarPersonaje(${index})">Editar</button>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
